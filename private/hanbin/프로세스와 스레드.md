# 프로세스와 스레드

## 프로세스 개요

- 프로그램은 실행되기 전에는 보조기억장치에 있는 데이터 덩어리지만,
  메모리에 적재되고 실행하는 순간 프로세스가 됨
  -> **프로세스를 생성한다**
- 프로세스 확인하기
  - 윈도우의 작업 관리자
  - 유닉스 계열의 `ps` 명령어
- 포그라운드 프로세스(foreground process)
  - 사용자가 볼 수 있는 공간에서 실행되는 프로세스
- 백그라운드 프로세스(background process)
  - 사용자와 상호작용할 수 있는 / 없는 프로세스로 나뉨
  - 후자의 경우
    - 유닉스 계열에서는 데몬(daemon)
    - 윈도우에서는 서비스(service)



### 프로세스 제어 블록

- 한정된 CPU 자원을 프로세스간 공유하기 위해 타이머 인터럽트 이용

- PCB; Process Control Block
  - 프로세스와 관련된 정보를 저장
  - 커널 영역에 생성
  - 프로세스 생성 시 생성, 프로세스 종료 시 폐기



#### PCB에 저장되는 정보

- 프로세스 ID
  - 식별 정보
  - PID; Process ID
- 레지스터 값
  - 해당 프로세스가 사용했던 레지스터 값들
    - 프로그램 카운터 등
  - 해당 프로세스의 실행 차례가 되었을 때 복원되어야 하는 값들
- 프로세스 상태
  - I/O 대기, CPU 대기, CPU 이용 중 등의 상태 정보
- CPU 스케줄링 정보
  - 해당 프로세스가 언제, 어떤 순서로 CPU를 할당받을 것인지
- 메모리 관리 정보
  - 각 프로세스마다 메모리에 저장된 위치가 다르기에
  - 프로세스가 어느 주소에 저장되었는가에 대한 정보 저장됨
    - 베이스 레지스터, 한계 레지스터 등의 정보
    - 페이지 테이블 정보
- 사용한 파일과 입출력장치 목록



### 문맥 교환

- 문맥(context)
  - 프로세스 수행 재개를 위해 기억해야 할 정보
  - PCB 저장되는 정보들
- 문맥 교환(Context switching)
  - 기존 프로세스의 문맥을 PCB에 백업
  - 새 프로세스를 위한 문맥을 PCB에서 복구
- 문맥 교환이 너무 많이 발생하면 오버헤드가 발생할 수 있음



### 프로세스의 메모리 영역

- 프로세스가 생성될 때
  - 커널 영역에는 PCB 생성
  - 사용자 영역에서는 프로세스가 다음과 같은 방식으로 저장됨
- 정적 할당 영역
  - 크기가 고정된 영역
  - 코드 영역(code segment)
    - 텍스트 영역(text segment)
    - CPU가 실행할 기계어 명령어가 저장됨
    - 읽기 전용
  - 데이터 영역(data segment)
    - 프로그램이 실행되는 동안 유지될 데이터 저장
      - 전역 변수(global variable)
- 동적 할당 영역
  - 힙 영역(heap segment)
    - 프로그래머가 직접 할당할 수 있는 영역
    - 언젠가 반환해야 하는 구역
      - 반환이 이루어지지 않을 경우 메모리 누수(memory leak) 발생
  - 스택 영역(stack segment)
    - 데이터를 일시적으로 저장하는 공간
      - 매개 변수, 지역 변수
- 메모리 주소
  - 코드 영역
  - 데이터 영역
  - 힙 영역
    - 데이터 영역 이후 낮은 주소부터 높은 주소로 할당
  - 스택 영역
    - 높은 주소에서 낮은 주소로 할당



## 프로세스 상태와 계층 구조

### 프로세스 상태

- 생성 상태(new)

  - 막 메모리에 적재되어 PCB를 할당받은 상태

- 준비 상태(ready)

  - 실행 가능한 상태지만 차례를 대기중인 상태

- 실행 상태(running)

  - CPU를 할당받아 실행 중인 상태
  - 할당된 시간이 다 지날 경우 타이머 인터럽트가 발생, 준비 상태가 됨
  - 입출력 장치를 기다려야 할 경우 대기 상태가 됨
  - 디스패치(dispatch)
    - ready -> running으로 전환되는 것

- 대기 상태(blocked)

  - 입출력 장치의 작업을 기다리는 상태
    - 입출력 작업 외의 다른 이벤트를 대기할 때도 해당
  - 입출력 장치는 CPU에 비해 작업 속도가 느림
  - 입출력 완료 인터럽트를 받을 떄까지 대기

- 종료 상태(terminated)

  - 프로세스가 종료된 상태
  - 종료 시, 운영체제는 PCB와 프로세스가 사용한 메모리를 정리

- 프로세스 상태 다이어그램(process state diagram)

  ```mermaid
  flowchart LR
  A([생성 상태]) --> B([준비 상태])
  B --디스패치--> C([실행 상태])
  C --타이머 인터럽트--> B
  C --입출력 요청--> E([대기 상태])
  E --입출력 완료--> B
  C --> F([종료 상태])
  ```



### 프로세스 계층 구조

- 프로세스는 실행 중 시스템 호출을 통해 다른 프로세스를 생성 가능
  - 부모 프로세스(parent process)가 자식 프로세스(child process)를 생성
  - 부모 프로세스와 자식 프로세스는 서로 다른 PID를 가짐
  - 일부 운영체제의 경우 자식 프로세스의 PCB에 부모 프로세스의 PID인 PPID; Parent PID를 기록하기도
- 프로세스 계층 구조
  - 부모 - 자식 - 자식의 자식으로 이어지는 프로세스의 계층 구조
  - 최초의 프로세스
    - 유닉스 계열: `init`
    - 리눅스 계열: `systemmd`
    - macOS: `launchd`
    - PID는 항상 1



### 프로세스 생성 기법

- fork - exec

  - 자식 프로세스의 실행 과정

    - 부모 프로세스는 fork를 통해 복사본을 자식 프로세스로 생성

    - 자식 프로세스는 exec을 통해 자신의 메모리 공간을 다른 프로그램으로 교체

  - fork와 exec은 모두 시스템 호출
    - fork
      - 자신 프로세스의 복사본을 만드는 호출
      - 자식 프로세스의 경우 부모 프로세스의 복사본이기에
        PID, 메모리 위치를 제외한 부모 프로세스의 자원들을 상속받음
    - exec
      - 자신의 메모리 공간을 새 프로그램으로 덮어 쓰는 호출
      - 코드 영역, 데이터 영역이 새 프로그램의 내용으로 변경되며
      - 나머지 영역은 초기화됨



## 스레드

- 스레드(Thread)
  - 프로세스를 구성하는 실행의 흐름 단위
  - 하나의 프로세스는 여러 스레드를 가질 수 있음



### 프로세스와 스레드

- 단일 스레드 프로세스
  - 한 번에 하나의 작업을 처리하는 프로세스
  - 실행 흐름 단위가 하나
- 멀티 스레드 프로세스
  - 하나의 프로세스가 여러 일을 수행할 수 있게 됨
- 스레드의 구성
  - 프로세스 내에서 서로 다른 스레드 ID
  - PC 값을 포함한 레지스터 값
  - 스택
- 스레드들은 최소한의 정보만을 유지한 채, **프로세스 자원을 공유하며** 실행됨
- 최근 많은 운영체제는 CPU에 처리할 작업을 전달할 때
  프로세스가 아닌 스레드 단위로 전달함
- 리눅스의 프로세스와 스레드
  - 리눅스의 경우 프로세스와 스레드를 명확하게 구별하지 않음
  - 실행의 문맥(context of execution)이라는 면에서 프로세스와 스레드 모두 동등하다고 간주(Linus Torvalds)
  - `task`로 통일하여 명명



### 멀티프로세스와 멀티스레드

- 멀티프로세스(multiprocess): 여러 프로세스를 동시 실행
- 멀티스레드(multithread): 여러 스레드로 프로세스를 동시 실행
- 멀티프로세스 vs 멀티스레드
  - 프로세스끼리는 자원을 공유하지 않지만
  - 스레드끼리는 자원을 공유한다는 차이점!
    - 스레드의 경우 메모리 효율성이 우월
    - 스레드의 경우 상호 협력 및 통신에 유리함
    - 멀티스레드의 경우 한 스레드에 문제가 생길 경우 프로세스 전체에 문제가 생길 수 있다는 단점
- 프로세스 간 통신(IPC; Inter-Process Communication)
  - 프로세스 사이에 자원을 공유하고 데이터를 주고받는 것
  - 통신 매개
    - 공유 메모리(shared memory)
      - 프로세스 간 공유하는 메모리 영역
    - 파일: 파일을 통한 프로세스 간 통신
    - 소켓, 파이프 등 ...
  - 프로세스 간 통신도 스레드에 비해 까다로울 뿐 가능은 함



- 경쟁 상태(Race condition)

- 동기화

- 데드락(Dead lock)