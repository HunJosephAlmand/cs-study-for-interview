> Redis에 알아보기 전에 Cache의 개념에 대해 정리하고 가자. 

## Cache 
Cache란 나중에 요청할 결과를 미리 저장해둔 후 빠르게 서비스해주는 것을 의미한다. 즉, 미리 결과를 저장하고 나중에 요청이 오면 그 요청에 대해서 DB 또는 API를 참조하지 않고 Cache를 접근하여 요청을 처리하는 기법이다. 
이러한 캐시가 나온 배경에는 파레토 법칙이 있다. 파레토 법칙이란 80%의 결과는 20%의 원인으로 인해 발생한다는 뜻이다. 
즉, 캐시는 모든 결과를 캐싱할 필요가 없으며 서비스를 할 때 많이 사용되는 20%만 캐싱함으로써 전체적으로 효율을 끌어올릴 수 있다는 것이다. 

이외에도 메모리 측면의 캐시 개념으로 속도가 느린 장치와 빠른 장치에서 속도 차이로 인한 병목 현상을 줄이기 위한 메모리이다. 
실제로 RAM과 CPU는 연산속도 편차가 심하기 때문에 캐시 메모리를 중간에 두는 것으로 속도 차이를 해결하고 있다. 비슷한 논리로 CPU와 HDD/SSD 속도 차이가 매우 심하여 RAM을 캐시메모리라고 부르기도 한다. 

### Cache를 고려하게 되는 순간 
서비스를 처음 운영할 때는 WEB - WAS - DB 정도로 작게 인프라를 구축해도 되지만 사용자가 늘어나 트래픽이 늘어나게 되면 점점 DB에 무리가 가기 시작한다. 
DB는 데이터를 물리 디스크에 직접 쓰기 때문에 서버에 문제가 발생해도 데이터가 손실되지는 않지만, 매 트랜잭션마다 디스크에 접근해야하므로 부하가 많아지면 성능이 떨어지게 된다. 

그래서 사용자가 늘어나면 DB를 스케일 인 또는 스케일 아웃하는 방식 외에도 캐시 서버를 검토하게 된다.

### Cache 사용 구조 
기본적인 캐시 사용 과정은 다음과 같다. (여기서 서버와 DB를 예로 들었지만 서버를 CPU, 데이터베이스를 메모리로 봐도 무방하다.)
![](https://i.imgur.com/gALKYIM.png)
1. 클라이언트로부터 요청을 받는다. 
2. Cache와 작업을 한다. 
3. 실제 DB와 작업한다. 
4. 다시 Cache와 작업한다. 

클라이언트가 웹 서버에 요청을 보내면, 웹 서버는 데이터를 DB에서 가져 오기 전에 캐시에 데이터가 있는 지 확인하고, 있다면 바로 클라이언트에게 저장된 데이터를 반환한다. 이를 Cache Hit라고 한다.

반대로 캐시에 데이터가 없으면 DB에 데이터를 요청하여 원하는 데이터를 조회한 후 그 데이터를 클라이언트에게 제공하는데, 이를 Cache Miss라고 한다. 

위 과정에서 캐시를 어떻게 사용하느냐에 따라서 대표적인 캐시 전략인 look aside cache와 write back으로 나뉜다. 

**Look Aside Cache**
1. 캐시에 데이터 존재 유무 확인 
2-1. 데이터가 있다면 캐시의 데이터 사용 
3-1. 데이터가 없다면 캐시의 실제 DB 데이터 사용 
3-2. DB에서 가져온 데이터를 캐시에 저장 
Look Asdie Cache는 캐시 저장소에 데이터가 있으면, 캐시에서 가져오고, 없다면 메인 DB에서 값을 가져오는 대표적인 캐시 전략이다. 
하지만 이 전략은 데이터에 수정이 일어날 시 동기화를 해줘야 하며 다음과 같은 방식을 사용한다. 
1. 애플리케이션이 새로운 데이터 쓰기 혹은 업데이트할 때 캐시와 DB 모두에 같은 작업을 실행하는 방법 
2. 애플리케이션의 모든 쓰기 작업은 DB에만 적용되고, 기존의 캐시 데이터를 무효화시키는 방법

**Write Back** 
1. 모든 데이터를 캐시에 저장 
2. 캐시의 데이터를 일정 주기마다 DB에 한꺼번에 저장 - 배치 
3. DB에 저장한 데이터를 캐시에서 제거 
write back은 주로 쓰기 작업이 굉장히 많아서, 쿼리를 일일이 날리지 않고 한꺼번에 배치 처리를 하기 위해 사용된다. 예를 들어 게시물을 클릭했을 때 조회수가 올라가는 서비스가 있을 때, 여러 사람이 동시에 게시물을 클릭하면 DB에 갑작스럽게 엄청난 쓰기 요청이 몰리게 되어 DB서버가 죽거나 조회수가 유실되는 문제가 있을 수 있다. 이때 write back 기반의 캐시를 적용하면 캐시 메모리에 데이터를 저장해 놓고, 이후 DB 디스크에 업데이트 해주면 안전하게 쓰기 작업을 해줄 수 있는 것이다. 
DB에서 디스크를 접근하는 횟수가 줄어들기 때문에 성능 향상을 기대할 수 있지만, DB에 데이터를 저장하기 전에 캐시가 죽어버리면 데이터가 유실된다는 문제점이 있다.

> 필자도 역시 프로젝트를 진행하며 태그 조회시 Look Aside Cache 방식을 사용하였다. 
> 그 이유는 쓰기 성능 개선보단 조회 성능 개선하기 위해서는 Look Aside Cache방식이 더 적합했기 때문이다.
> 동기화를 위해 태그가 생성되었을 때 해당 하는 유저의 태그 목록을 캐시에서 삭제하는 식으로 구현하였다.





## Reference 
- https://github.com/alstjgg/cs-study/blob/main/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4/Redis%EB%9E%80.md
- https://github.com/2021-pick-git/2021-pick-git.github.io/blob/main/_posts/2021-10-19-spring-cache-with-redis.md